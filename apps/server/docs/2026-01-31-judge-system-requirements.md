# 法官系统需求文档（草案）

## 背景与目标
当前对话在出现强争议的交易观点时（例如“现在买入某个 meme 币”），主 Agent 需要引入一个“法官”来裁决争议，给出胜方与详细理由，以提升建议的可信度与结构化程度。法官系统需与现有 SPOONOS 技术栈兼容，作为子 Agent 被主 Agent 调用，不改变现有 SSE 通道协议。核心目标是：让争议性观点进入“开庭”流程，输出可用于最终建议的裁决报告，并将报告显式加入当前会话上下文中。

## 触发与输入
触发方式由主 Agent 进行意图识别（软触发）：当用户提出交易上不明确、争议性强、或需要正反论证的观点时，主 Agent 进入“开庭”流程。开庭输入严格为三项：
- issue：核心议题
- pro：正方观点（支持立场）
- con：反方观点（反对立场）

这些输入由主 Agent 在对话过程中整理并生成，然后通过 subAgentCall 发送给法官子 Agent。无需用户显式手动触发，无需额外的市场数据或用户画像字段（后续可扩展）。

## 多轮争吵流程
一次“开庭”允许多轮对话。主 Agent 在每一轮收集正反双方的新论点，并将本轮更新内容发送给法官。法官需要基于累计证据与新信息更新裁决倾向。该流程直到满足终止条件（见下）才结束。

## 天平血条机制
法官持有一个“天平血条”，用来表达当前正反双方的胜负倾向。血条初始为中立（50/50），每轮更新时按论点力度与证据质量调整倾向。血条变化既可作为内部裁决依据，也应在裁决报告中以结构化方式呈现（例如“当前倾向：正方 60% / 反方 40%”）。

## 终止条件
满足任一条件即可结束争吵并输出最终裁决报告：
- 血条完全倾向一方（例如 ≥ 90%）；
- 达到最大轮次（默认 3-5 轮，可配置）；
- 新论点不足以改变倾向（连续两轮变化 < 5%）。

## 法官 Agent 职责与输出
法官 Agent 为中立裁决角色，负责衡量双方论点力度。裁决以“天平血条”概念表达观点权重，但该机制可作为内部评估逻辑或结构化输出，无需改变协议。法官输出必须包含：
1) 胜方（正方/反方）
2) 核心理由（简明扼要）
3) 详细评分：
   - 论点力度
   - 证据质量
   - 与用户情境适配度
4) 风险提示或建议
5) 血条倾向与变化说明（例如每轮增减原因与当前比例）

输出作为可读文本回传给主 Agent，主 Agent 将其加入当前会话上下文，并基于裁决生成最终建议。

## 技术落地路径（方案 A）
采用现有 sub-agent 机制：新增 Judge 子 Agent，并通过 SubAgentTool 进行调用。主 Agent 负责识别争议、组织开庭输入、调用法官并整合裁决。

建议实现点：
- `apps/server/spoonos_server/core/agents/judge_agent.py`：法官 agent 构建工厂（SpoonReactAI + system prompt）。
- `apps/server/spoonos_server/core/agents/sub_agents.py`：允许注册默认法官子 Agent 或由主 Agent 动态触发。
- `apps/server/spoonos_server/core/agents/react_agent.py`：主 Agent 的 system prompt 增加“争吵触发-调用法官”的规则。

## 会话上下文与展示
法官报告必须写入当前会话上下文中，确保后续建议以裁决为依据。UI 层可直接展示该文本作为 assistant 消息；天平血条等视觉表现由前端基于内容解析或事件标识实现（不要求协议改动）。

## 验收标准（初稿）
- 当用户提出争议性交易观点时，主 Agent 能自动调用法官子 Agent。
- 法官输出包含胜方、核心理由、详细评分、风险提示。
- 法官输出进入当前会话上下文，主 Agent 能基于其输出给出最终建议。
- 现有 SSE 流与 API 请求格式保持兼容。
